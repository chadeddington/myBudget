<link rel="import"  href="../components/polymer/polymer.html">
<link rel="import" href="../components/app-route/app-location.html">
<link rel="import" href="../components/app-route/app-route.html">
<link rel="import" href="../components/iron-selector/iron-selector.html">
<link rel="import" href="../components/iron-pages/iron-pages.html">
<link rel="import" href="budget-login.html">
<link rel="import" href="budget-overview.html">
<link rel="import" href="budget-details.html">
<!-- import style module  -->
<link rel="import" href="bs-styles.html">

<dom-module id="budget-app">
  <template>
    <!-- consume the style module-->
    <style is="custom-style" include="bs-styles"></style>
    <style>
      a:hover {
        cursor: pointer;
      }
    </style>

    <!--Route handler-->
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
        route="{{route}}"
        pattern="/:page"
        data="{{routeData}}"
        tail="{{subroute}}"></app-route>
    <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
      <nav class="pure-menu pure-menu-horizontal">
        <ul class="pure-menu-list">
          <li class="pure-menu-item"><a class="pure-menu-link" name="home" href="#/home">Overview</a></li>
          <li class="pure-menu-item"><a class="pure-menu-link" on-tap="signOut">Sign Out</a></li>
          <li class="pure-menu-item"><a class="pure-menu-link" on-tap="getItems">Get Items</a></li>
        </ul>
      </nav>
    </iron-selector>
    <iron-pages
        class='views'
        selected="[[page]]"
        attr-for-selected="name"
        fallback-selection="view404"
        role="main">
      <!--Log in View-->
      <budget-login name="login"></budget-login>
      <!-- Main View-->
      <budget-overview 
        name="home" 
        items="[[items]]" 
        date="[[date]]"
        month="[[month]]"></budget-overview>

      <budget-details id="details" name="details"></budget-details>
      
      <p name="view404">404</p>
    </iron-pages>
  </template>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCWL3D86-JOSBusrf2pkTamQH-XcYiPleo",
      authDomain: "mybudget-c0f97.firebaseapp.com",
      databaseURL: "https://mybudget-c0f97.firebaseio.com",
      storageBucket: "mybudget-c0f97.appspot.com",
      messagingSenderId: "825455221523"
    };
    firebase.initializeApp(config);

    // Get a reference to the database service
    var database = firebase.database();

    var date = new Date();
    var month = [
      'January',
      'February',
      'March',
      'April',
      'May',
      'June',
      'July',
      'August',
      'September',
      'October',
      'Novermber',
      'December'
    ]

    Polymer({
      is: 'budget-app',
      properties: {
        page: {
          type: String,
          reflectToAttribute: true
        },
        items: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        userId: {
          type: String,
          value: ''
        },
        date: {
          type: Object,
          value: function() {
            return date;
          },
          notify: true
        },
        month: {
          type: String,
          value: function() {
            return month[date.getMonth()];
          },
          notify: true
        }
      },
      observers: [
        '_routePageChanged(routeData.page, subroute.path)',
      ],
      listeners : {
      'register-user': 'register',
      'sign-in-user': 'signIn',
      'iron-select': 'loginCheck',
      'create-category': 'createCategory',
      'delete-category': 'deleteCategory',
      'view-details' : 'viewDetails'
      },
      /**
      * Set up value change listener on the data
      */
      getItems: function() {
        var itemsRef = '/users/' + this.userId + '/' + this.date.getFullYear() + '/' + this.month;
        // Pull down their data
        firebase.database().ref(itemsRef).on('value', this.updateItems.bind(this));
      },
      _routePageChanged: function(page, tail) {
        this.page = page || 'home';

        // Handle subroutes
        if (tail && page === 'details') {
           var index = tail.match(/[0-9]+/)[0];
          if (this.items.length) {
            // If the items are on the page, pass in the right one
            this.$.details.item = this.items[index];
          } else {
            // If they are not on the page pull down the one 
            this.$.details.index = index;
          }  
        }
      },
      /*
      * Register a new user
      */
      register: function(e) {
        var email = e.detail.email;
        var password = e.detail.password;
        var firstName = e.detail.firstName;
        var lastName = e.detail.lastName;
        // Create user
        firebase.auth().createUserWithEmailAndPassword(email, password).then(function(data) {
          // For debugging
          // console.log("Successfully created user",data);
          // Add user to the list of users
          firebase.database().ref('users/' + data.uid + '/userInfo').set({
            email: data.email,
            firstName: firstName,
            lastName: lastName,
            lastYearEdited: null
          });
          // redirect to dashboard
          window.location.replace(window.location.origin + "/")
        },function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // Log that an error occured
          console.error("Error Registering:", errorMessage);
        });
      },
      /**
      * Sign in
      */
      signIn: function(e) {
        var email = e.detail.email;
        var password = e.detail.password;
        var _this = this;
        firebase.auth().signInWithEmailAndPassword(email, password).then(function(user) {
          _this.getItems(user.uid);
          // redirect to dashboard
          window.location.replace(window.location.origin + "/")
        }, function(error) {
          // Handle Errors here.
          var errorCode = error.code;
          var errorMessage = error.message;
          // Log that an error occured
          console.error('Sign in error:', error.message);
        });
      },
      /**
      * Sign out
      */
      signOut: function() {
        var _this = this;
        firebase.auth().signOut().then(function() {
          // Sign-out successful.
          console.log('You have signed out!');
          _this.userId = '';
        }, function(error) {
          // An error happened.
          console.log('There was an error logging you out');
        });
      },
      /**
      * Make sure user is logged in
      */
      loginCheck: function(e) {
        //check if logged in
        firebase.auth().onAuthStateChanged(function(user) {
          if (user) {
            // User is signed in.
            console.log("You are signed in!", user.email)
            this.userId = user.uid;
          } else {
            // No user is signed in.
            console.log('no user is logged in');
            window.location.replace(window.location.origin + "/#/login")
          }
        }.bind(this));
      },
      /** 
      * Update the data
      */
      updateItems: function(snapshot) {
        var keys = Object.keys(snapshot.val());
        var items = [];
        // convert the object into an array of items
        items = keys.map(function(item) {
          var obj = snapshot.val()[item];
          obj.id = item;
          return obj;
        })
        this.items = items;

        if (this.page === 'details') {
         this.$.details.item = items[this.subroute.path.match(/[0-9]+/)[0]] 
        }
      },
      /**
      * Create a new category
      */
      createCategory: function(e) {
        // Add category to firebase
        firebase.database().ref('users/' + this.userId + '/' + e.detail.year + '/' + e.detail.month).push().set({
          category: e.detail.categoryName,
          budget: e.detail.budget,
          total: 0
        });
      },
      /**
      * Detele a category
      */
      deleteCategory: function(e) {
        var id = e.detail.id;
        var catRef = firebase.database().ref('users/' + this.userId + '/' + e.detail.year + '/' + e.detail.month + '/' + id);
        catRef.remove().then(function() {
          // console.log("Remove succeeded.")
        })
        .catch(function(error) {
          console.log("Remove failed: " + error.message)
        });
      }
    });
  </script>
</dom-module>
